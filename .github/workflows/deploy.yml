name: Deploy to Kubernetes

on:
  push:
    branches:
      - main

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: ${{ secrets.GCP_REGION }}
  GKE_CLUSTER: ${{ secrets.GKE_CLUSTER }}
  NAMESPACE: crashthecrease

jobs:
  deploy:
    runs-on: ubuntu-latest
    needs: []
    permissions:
      contents: read
      id-token: write
      packages: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Install gke-gcloud-auth-plugin
        run: |
          gcloud components install gke-gcloud-auth-plugin

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
            --region ${{ env.GCP_REGION }} \
            --project ${{ env.GCP_PROJECT_ID }}

      - name: Determine image tag
        id: image-tag
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          echo "tag=main-${SHORT_SHA}" >> "$GITHUB_OUTPUT"
          echo "image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main-${SHORT_SHA}" >> "$GITHUB_OUTPUT"

      - name: Wait for image availability
        run: |
          IMAGE="${{ steps.image-tag.outputs.image }}"
          echo "Waiting for image: ${IMAGE}"
          for i in $(seq 1 30); do
            if docker manifest inspect "${IMAGE}" > /dev/null 2>&1; then
              echo "Image is available"
              exit 0
            fi
            echo "Attempt ${i}/30: Image not yet available, waiting 10s..."
            sleep 10
          done
          echo "Timed out waiting for image"
          exit 1
        env:
          DOCKER_CLI_EXPERIMENTAL: enabled

      - name: Deploy backend pod
        run: |
          cat <<EOF | kubectl apply -f -
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: backend
            namespace: ${{ env.NAMESPACE }}
            labels:
              app: backend
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: backend
            template:
              metadata:
                labels:
                  app: backend
              spec:
                imagePullSecrets:
                  - name: ghcr-pull-secret
                containers:
                  - name: backend
                    image: ${{ steps.image-tag.outputs.image }}
                    ports:
                      - containerPort: 8080
                    env:
                      - name: APP_ENV
                        value: production
                      - name: PORT
                        value: "8080"
                      - name: GCP_PROJECT_ID
                        valueFrom:
                          secretKeyRef:
                            name: app-secrets
                            key: GCP_PROJECT_ID
                      - name: DISCORD_BOT_TOKEN
                        valueFrom:
                          secretKeyRef:
                            name: app-secrets
                            key: DISCORD_BOT_TOKEN
                    resources:
                      requests:
                        cpu: 100m
                        memory: 128Mi
                      limits:
                        cpu: 500m
                        memory: 256Mi
                    readinessProbe:
                      httpGet:
                        path: /healthz
                        port: 8080
                      initialDelaySeconds: 5
                      periodSeconds: 10
                    livenessProbe:
                      httpGet:
                        path: /healthz
                        port: 8080
                      initialDelaySeconds: 10
                      periodSeconds: 30
          EOF

      - name: Deploy backend service
        run: |
          cat <<EOF | kubectl apply -f -
          apiVersion: v1
          kind: Service
          metadata:
            name: backend
            namespace: ${{ env.NAMESPACE }}
            labels:
              app: backend
          spec:
            selector:
              app: backend
            ports:
              - protocol: TCP
                port: 80
                targetPort: 8080
            type: ClusterIP
          EOF

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/backend \
            --namespace ${{ env.NAMESPACE }} \
            --timeout=300s

      - name: Verify deployment
        run: |
          echo "--- Deployment Status ---"
          kubectl get deployment backend -n ${{ env.NAMESPACE }}
          echo "--- Pod Status ---"
          kubectl get pods -n ${{ env.NAMESPACE }} -l app=backend
          echo "--- Service ---"
          kubectl get service backend -n ${{ env.NAMESPACE }}
